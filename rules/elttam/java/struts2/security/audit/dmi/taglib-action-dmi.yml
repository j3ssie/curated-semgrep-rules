rules:
  - id: taglib-action-dmi
    message: >-
      JSTL taglib directive
      either Dynamic Method Invocation (DMI) or Wildcard Method feature
      prefix="$...PREFIX"
      uri="$...URI"
      action="$...ACTION"
    severity: INFO
    languages: [generic]
    metadata:
      docs:
        - https://struts.apache.org/core-developers/action-configuration.html#dynamic-method-invocation
        - https://struts.apache.org/core-developers/action-configuration.html#wildcard-method
      category: security
      subcategory: audit
      likelihood: LOW
      impact: LOW
      confidence: LOW
      technology:
        - JVM
        - Struts2
        - JSTL
        - taglib
    paths:
      include:
        - '*.jsp'
    # NOTE: need to use `"$...URI"` etc to capture strings like `"/struts"`.
    # Due to the `/`, which breaks the binding.
    patterns:
      - pattern-either:
          - pattern-inside: |
              <%@ taglib prefix='$...PREFIX' ... uri='$...URI'
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
          - pattern-inside: |
              <%@ taglib prefix="$...PREFIX" ... uri="$...URI"
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
          - pattern-inside: |
              <%@ taglib uri='$...URI' ... prefix='$...PREFIX'
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
          - pattern-inside: |
              <%@ taglib uri="$...URI" ... prefix="$...PREFIX"
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
              ...
      - pattern-either:
          - pattern: |
              <$...PREFIX:... ... action='$...ACTION'
          - pattern: |
              <$...PREFIX:... ... action="$...ACTION"
      - metavariable-regex:
          metavariable: $...ACTION
          regex: >-
            .*!.*
      #- focus-metavariable: $...ACTION
